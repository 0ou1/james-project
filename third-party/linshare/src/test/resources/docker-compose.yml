# Docker compose file for a full-featured Linshare architecture
version: '3.7'

services:
    database:
        container_name: linshare_database
        restart: on-failure
        image: docker-registry.linagora.com:5000/linshare-snapshots/linshare-database:2.3
        environment:
            - PGDATA=/var/lib/postgresql/data/pgdata
            - POSTGRES_USER=linshare
            - POSTGRES_PASSWORD=linshare

    backend:
        container_name: linshare_backend
        restart: on-failure
        image: docker-registry.linagora.com:5000/linshare-snapshots/linshare-backend:2.3
        ports:
            - 28080:8080
        links:
            - database:linshare_database
            - mongodb:linshare_mongodb
        depends_on:
            - database
            - mongodb
        volumes:
            - ./conf/catalina.properties:/usr/local/tomcat/conf/catalina.properties
            - ./conf/log4j.properties:/etc/linshare/log4j.properties
            - ./ssl/id_rsa:/etc/linshare/id_rsa
            - ./ssl/id_rsa.pub:/etc/linshare/id_rsa.pub
        healthcheck:
            test: ["CMD", "curl", "-s", "-f", "http://localhost:8080/linshare/"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        environment:
            # These variables are mandatory
            - SMTP_HOST=linshare_smtp
            - SMTP_PORT=25
            - CLAMAV_HOST=linshare_clamav
            - CLAMAV_PORT=3310
            - POSTGRES_HOST=linshare_database
            - POSTGRES_PORT=5432
            - POSTGRES_USER=linshare
            - POSTGRES_PASSWORD=linshare
            - MONGODB_HOST=linshare_mongodb
            - MONGODB_PORT=27017
            - THUMBNAIL_ENABLE=false

    mongodb:
        container_name: linshare_mongodb
        restart: on-failure
        image: mongo:3.2
        command: mongod --smallfiles

    smtp:
        container_name: linshare_smtp
        restart: on-failure
        image: linagora/opensmtpd
        volumes:
            - ./conf/smtpd.conf:/etc/smtpd/smtpd.conf

    ldap:
        image: docker-registry.linagora.com:5000/linshare-snapshots/linshare-ldap-for-tests
        container_name: linshare_ldap
        tty: true
        stdin_open: true
        ports:
            - "20389:389"

    database-init:
        container_name: linshare_database-init
        image: docker-registry.linagora.com:5000/linshare-snapshots/linshare-database-init:2.3
        links:
            - backend:linshare_backend
        depends_on:
            - backend
            - ldap
        environment:
            - TOMCAT_HOST=linshare_backend_dev
            - TOMCAT_PORT=8080
            - TOMCAT_LDAP_NAME=ldap-local
            - TOMCAT_LDAP_URL=ldap://ldap:389
            - TOMCAT_LDAP_BASE_DN=ou=People,dc=linshare,dc=org
            - TOMCAT_LDAP_DN=cn=linshare,dc=linshare,dc=org
            - TOMCAT_LDAP_PW=linshare
            - TOMCAT_DOMAIN_PATTERN_NAME=openldap-local
            - TOMCAT_DOMAIN_PATTERN_MODEL=868400c0-c12e-456a-8c3c-19e985290586
            - NO_REPLY_ADDRESS=linshare-noreply@linshare.org
            - DEBUG=1
            - FORCE_INIT=1

networks:
    linshare-backend-tier:
        driver: bridge


